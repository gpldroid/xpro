<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAMI X-PRO | مشغل IPTV متعدد البروتوكولات</title>
    
    <!-- الروابط الخارجية -->
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/2965/2965363.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- أنماط CSS -->
    <style>
        :root {
            --bg-body: #050505; --bg-card: #121212; --bg-sidebar: rgba(18, 18, 18, 0.98);
            --text-main: #ffffff; --text-secondary: #a1a1aa; --accent-color: #d4af37;
            --border-color: rgba(212, 175, 55, 0.15); --gradient-accent: linear-gradient(135deg, #d4af37 0%, #bf953f 100%);
        }
        .light-mode {
            --bg-body: #F0F2F5; --bg-card: #FFFFFF; --bg-sidebar: #FFFFFF;
            --text-main: #050505; --text-secondary: #65676B; --accent-color: #1877F2; --border-color: #dddfe2;
        }
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Cairo', sans-serif; 
            transition: 0.3s; 
        }
        
        /* تحسينات لمشغل الفيديو */
        #player-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .stream-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10;
        }
        
        .protocol-selector {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .buffer-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
        }
        
        .quality-selector {
            position: absolute;
            bottom: 60px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            border-radius: 5px;
            padding: 10px;
            display: none;
            z-index: 10;
        }
        
        /* تحسينات للقوائم */
        .media-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.2);
        }
        
        /* تحسينات للشريط الجانبي */
        .sidebar {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        
        /* تحسينات للبحث */
        .search-highlight {
            background-color: rgba(212, 175, 55, 0.3);
            color: var(--accent-color);
        }
        
        /* تحسينات للتحميل */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* تحسينات للاستجابة */
        @media (max-width: 768px) {
            #player-container {
                border-radius: 0;
            }
            
            .media-card {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

    <!-- زر الواتساب -->
    <a href="https://wa.me/212783539816" target="_blank" class="whatsapp-btn">
        <i class="fab fa-whatsapp"></i>
    </a>
    
    <!-- زر العودة للأعلى -->
    <div id="backToTop" class="back-to-top" onclick="window.scrollTo({top:0, behavior:'smooth'})">
        <i class="fas fa-arrow-up"></i>
    </div>
    
    <!-- الشريط الجانبي -->
    <aside id="sidebar" class="sidebar">
        <!-- محتوى الشريط الجانبي -->
        <div class="flex justify-between items-center mb-8 pb-4 border-b border-[var(--border-color)]">
            <div class="text-xl font-black text-[var(--accent-color)]">DAMI X-PRO</div>
            <i class="fas fa-times cursor-pointer text-xl" onclick="toggleSidebar()"></i>
        </div>
        <nav>
            <div class="sidebar-link" onclick="location.reload()">
                <i class="fas fa-home"></i> <span data-i18n="home">الرئيسية</span>
            </div>
            <div class="sidebar-link" onclick="openModal('about')">
                <i class="fas fa-info-circle"></i> <span data-i18n="about">من نحن</span>
            </div>
            <div class="sidebar-link" onclick="window.open('https://wa.me/212783539816')">
                <i class="fas fa-envelope"></i> <span data-i18n="contact">اتصل بنا</span>
            </div>
            <div class="sidebar-link" onclick="openModal('privacy')">
                <i class="fas fa-user-shield"></i> <span data-i18n="privacy">سياسة الخصوصية</span>
            </div>
            <div class="my-4 border-t border-[var(--border-color)]"></div>
            <a href="https://dami-xpro.com/download" class="sidebar-link" style="background: var(--gradient-accent); color: white; border-radius: 12px;">
                <i class="fab fa-android"></i> <span data-i18n="download">تحميل التطبيق</span>
            </a>
        </nav>
    </aside>

    <!-- الرأس -->
    <header class="bg-[var(--bg-card)] border-b border-[var(--border-color)] sticky top-0 z-[50] p-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <i class="fas fa-bars cursor-pointer text-xl" onclick="toggleSidebar()"></i>
            <div class="text-xl font-bold">DAMI X-PRO</div>
        </div>
        <div class="flex items-center gap-3">
            <!-- اختيار اللغة -->
            <select id="langSelect" onchange="setLanguage(this.value)" class="bg-transparent border border-[var(--border-color)] rounded-lg px-2 py-1 text-sm outline-none text-[var(--text-main)]">
                <option value="ar">العربية</option>
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="es">Español</option>
            </select>
            <!-- زر تغيير السمة -->
            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-800/50 cursor-pointer" onclick="toggleTheme()">
                <i class="fas fa-moon" id="themeIcon"></i>
            </div>
        </div>
    </header>

    <!-- مشغل الفيديو -->
    <div class="player-wrapper w-full bg-black py-4">
        <div id="player-container">
            <div class="stream-info" id="streamInfo">
                <span id="currentProtocol">HTTP</span> | <span id="currentQuality">جودة تلقائية</span>
            </div>
            <div class="protocol-selector">
                <select id="protocolSelect" class="bg-transparent text-white text-sm outline-none">
                    <option value="http">HTTP</option>
                    <option value="https">HTTPS</option>
                    <option value="auto">تلقائي</option>
                </select>
            </div>
            <div class="buffer-indicator" id="bufferIndicator">
                <i class="fas fa-spinner fa-spin"></i> جاري التحميل...
            </div>
            <video id="player" playsinline controls crossorigin class="w-full"></video>
            <div class="quality-selector" id="qualitySelector">
                <!-- سيتم ملؤها ديناميكيًا -->
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <main class="max-w-7xl mx-auto p-4">
        <!-- شريط البحث -->
        <div class="relative max-w-2xl mx-auto my-8">
            <input type="text" id="searchInput" class="w-full bg-[var(--bg-card)] border-2 border-[var(--border-color)] rounded-full py-3 px-12 outline-none focus:border-[var(--accent-color)] text-[var(--text-main)]" placeholder="ابحث هنا...">
            <i class="fas fa-search absolute right-5 top-1/2 -translate-y-1/2 text-gray-500"></i>
        </div>

        <!-- أزرار التبديل -->
        <div class="flex max-w-md mx-auto bg-[var(--bg-card)] border border-[var(--border-color)] p-1 rounded-2xl mb-8">
            <button onclick="switchMode('live')" class="mode-btn active flex-1 py-2 rounded-xl text-sm font-bold" data-mode="live">
                <span data-i18n="live">مباشر</span>
            </button>
            <button onclick="switchMode('movies')" class="mode-btn flex-1 py-2 rounded-xl text-sm font-bold" data-mode="movies">
                <span data-i18n="movies">أفلام</span>
            </button>
            <button onclick="switchMode('series')" class="mode-btn flex-1 py-2 rounded-xl text-sm font-bold" data-mode="series">
                <span data-i18n="series">مسلسلات</span>
            </button>
        </div>

        <!-- الفئات -->
        <div id="categoriesContainer" class="flex overflow-x-auto gap-2 pb-4 mb-6"></div>

        <!-- شبكة المحتوى -->
        <div id="contentGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>

        <!-- مؤشر التحميل -->
        <div id="loader" class="hidden text-center p-10">
            <i class="fas fa-spinner fa-spin text-3xl text-[var(--accent-color)]"></i>
            <div class="mt-2">جاري تحميل المحتوى...</div>
        </div>

        <!-- زر تحميل المزيد -->
        <button id="loadMoreBtn" onclick="renderItems()" class="hidden mx-auto mt-8 bg-[var(--bg-card)] border border-[var(--accent-color)] text-[var(--accent-color)] px-10 py-2 rounded-full font-bold hover:bg-[var(--accent-color)] hover:text-white transition" data-i18n="load_more">
            عرض المزيد
        </button>
    </main>

    <!-- الفوتر -->
    <footer class="bg-[var(--bg-card)] border-t border-[var(--border-color)] p-10 text-center mt-20">
        <a href="https://dami-xpro.com/download" class="inline-flex items-center gap-3 bg-[var(--accent-color)] text-white px-8 py-3 rounded-full font-bold mb-8 hover:scale-105 transition">
            <i class="fab fa-android"></i> <span data-i18n="download">تحميل التطبيق</span>
        </a>
        <p class="font-bold text-xl mb-2 text-[var(--text-main)]">DAMI X-PRO &copy; <span id="year">2025</span></p>
        <p class="text-gray-500">Developed by <span class="text-[var(--accent-color)]">Imad Eddine Lamrani</span></p>
    </footer>

    <!-- النوافذ المنبثقة -->
    <div id="modal-about" class="modal" onclick="closeModal('about')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-[var(--accent-color)] mb-4" data-i18n="about">من نحن</h2>
            <p class="text-[var(--text-secondary)]" data-i18n="about_text">
                مشغل DAMI X-PRO هو منصة متطورة لمشاهدة المحتوى التلفزيوني عبر الإنترنت بدعم كامل لكل من بروتوكولي HTTP و HTTPS لتجنب توقف البث. نقدم تجربة مشاهدة سلسة وبدون انقطاع.
            </p>
            <button class="mt-6 px-8 py-2 bg-[var(--accent-color)] text-white rounded-lg" onclick="closeModal('about')" data-i18n="close">إغلاق</button>
        </div>
    </div>

    <div id="modal-privacy" class="modal" onclick="closeModal('privacy')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-[var(--accent-color)] mb-4" data-i18n="privacy">سياسة الخصوصية</h2>
            <p class="text-[var(--text-secondary)] text-sm">
                نحن نحترم خصوصيتك بشكل كامل. لا نقوم بتخزين أي بيانات شخصية أو تسجيل نشاط المشاهدة. جميع الاتصالات مشفرة وآمنة.
            </p>
            <button class="mt-6 w-full py-2 bg-[var(--accent-color)] text-white rounded-lg" onclick="closeModal('privacy')" data-i18n="close">إغلاق</button>
        </div>
    </div>

    <!-- المكتبات الخارجية -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js"></script>

    <!-- السكريبت الرئيسي -->
    <script>
        // التهيئة
        const API_CONFIG = {
            base_http: "http://99gopro.org:8080",
            base_https: "https://99gopro.org:8080", // تأكد من وجود HTTPS
            user: "4640611723208466",
            pass: "4640611723208466"
        };

        // دعم الترجمة
        const i18n = {
            ar: { 
                home: "الرئيسية", about: "من نحن", contact: "اتصل بنا", 
                privacy: "سياسة الخصوصية", download: "تحميل التطبيق", 
                live: "مباشر", movies: "أفلام", series: "مسلسلات", 
                load_more: "عرض المزيد", close: "إغلاق", 
                search: "ابحث هنا...", about_text: "مشغل IPTV متعدد البروتوكولات"
            },
            en: { 
                home: "Home", about: "About Us", contact: "Contact", 
                privacy: "Privacy", download: "Download App", 
                live: "Live", movies: "Movies", series: "Series", 
                load_more: "Load More", close: "Close", 
                search: "Search...", about_text: "Multi-protocol IPTV Player"
            }
        };

        // المتغيرات العامة
        let currentMode = 'live';
        let allData = [];
        let displayedCount = 0;
        let hls = null;
        let currentProtocol = 'auto';
        let player = null;

        // ==================== الدوال المساعدة ====================
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function openModal(id) {
            document.getElementById('modal-' + id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById('modal-' + id).style.display = 'none';
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('themeIcon');
            icon.className = document.body.classList.contains('light-mode') ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }

        function setLanguage(lang) {
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang] && i18n[lang][key]) {
                    el.innerText = i18n[lang][key];
                }
            });
            document.getElementById('searchInput').placeholder = i18n[lang].search;
            localStorage.setItem('lang', lang);
            fetchCategories();
        }

        // ==================== دوال البيانات ====================

        async function fetchData(action, params = {}) {
            const baseUrl = currentProtocol === 'https' ? API_CONFIG.base_https : API_CONFIG.base_http;
            let url = `${baseUrl}/player_api.php?username=${API_CONFIG.user}&password=${API_CONFIG.pass}&action=${action}`;
            
            // إضافة المعلمات
            Object.keys(params).forEach(key => {
                url += `&${key}=${params[key]}`;
            });

            try {
                // استراتيجية السقوط (Fallback Strategy)
                let response;
                try {
                    response = await fetchWithTimeout(url, 5000); // مهلة 5 ثوان
                } catch (e) {
                    // إذا فشل البروتوكول الحالي، جرب البروتوكول الآخر
                    const fallbackBase = currentProtocol === 'https' ? API_CONFIG.base_http : API_CONFIG.base_https;
                    const fallbackUrl = url.replace(baseUrl, fallbackBase);
                    console.log('جرب البروتوكول البديل:', fallbackBase);
                    response = await fetchWithTimeout(fallbackUrl, 5000);
                }

                if (!response.ok) throw new Error('فشل الاستجابة');
                
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('خطأ في جلب البيانات:', error);
                return [];
            }
        }

        function fetchWithTimeout(url, timeout) {
            return Promise.race([
                fetch(url),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('مهلة الطلب')), timeout)
                )
            ]);
        }

        async function fetchCategories() {
            const action = currentMode === 'live' ? 'get_live_categories' : 
                          currentMode === 'movies' ? 'get_vod_categories' : 
                          'get_series_categories';
            
            document.getElementById('loader').classList.remove('hidden');
            const cats = await fetchData(action);
            const container = document.getElementById('categoriesContainer');
            
            container.innerHTML = `
                <button onclick="loadCategory('all', this)" 
                        class="cat-btn whitespace-nowrap px-4 py-1 rounded-full bg-[var(--accent-color)] text-white text-sm font-bold">
                    الكل
                </button>`;
            
            if (Array.isArray(cats)) {
                cats.forEach(c => {
                    container.innerHTML += `
                        <button onclick="loadCategory('${c.category_id}', this)" 
                                class="cat-btn whitespace-nowrap px-4 py-1 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-sm">
                            ${c.category_name}
                        </button>`;
                });
            }
            
            document.getElementById('loader').classList.add('hidden');
            loadCategory('all');
        }

        async function loadCategory(id, btn = null) {
            if (btn) {
                document.querySelectorAll('.cat-btn').forEach(b => {
                    b.classList.remove('bg-[var(--accent-color)]', 'text-white', 'font-bold');
                    b.classList.add('bg-[var(--bg-card)]');
                });
                btn.classList.add('bg-[var(--accent-color)]', 'text-white', 'font-bold');
            }

            document.getElementById('contentGrid').innerHTML = '';
            document.getElementById('loader').classList.remove('hidden');

            const action = currentMode === 'live' ? 'get_live_streams' : 
                          currentMode === 'movies' ? 'get_vod_streams' : 
                          'get_series';
            
            const params = id !== 'all' ? { category_id: id } : {};
            allData = await fetchData(action, params);
            displayedCount = 0;
            
            document.getElementById('loader').classList.add('hidden');
            renderItems();
        }

        // ==================== عرض المحتوى ====================

        function renderItems() {
            const grid = document.getElementById('contentGrid');
            const chunk = Array.isArray(allData) ? allData.slice(displayedCount, displayedCount + 30) : [];
            
            chunk.forEach(item => {
                const div = document.createElement('div');
                div.className = 'media-card';
                
                const imageUrl = item.stream_icon || item.cover || 'https://via.placeholder.com/150';
                const title = item.name || item.title || 'بدون عنوان';
                const mediaId = item.stream_id || item.vod_id || item.id;
                
                div.innerHTML = `
                    <div class="relative">
                        <img src="${imageUrl}" 
                             class="w-full aspect-square object-cover bg-black rounded-lg"
                             onerror="this.src='https://via.placeholder.com/150'">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2">
                            <div class="text-xs font-bold truncate text-white text-center">${title}</div>
                        </div>
                    </div>`;
                
                div.onclick = () => playMedia(mediaId, item);
                grid.appendChild(div);
            });
            
            displayedCount += chunk.length;
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            loadMoreBtn.style.display = displayedCount < allData.length ? 'block' : 'none';
        }

        // ==================== تشغيل الوسائط ====================

        function playMedia(id, item) {
            showBufferIndicator(true);
            
            const video = document.getElementById('player');
            let streamUrl;
            
            // توليد رابط البث بناءً على النمط الحالي
            if (currentMode === 'live') {
                // قنوات البث المباشر
                streamUrl = generateStreamURL(id, 'live');
            } else if (currentMode === 'movies') {
                // الأفلام
                streamUrl = generateStreamURL(id, 'movie', item.container_extension);
            } else {
                // المسلسلات
                streamUrl = generateStreamURL(id, 'series', item.container_extension);
            }
            
            // إيقاف أي بث سابق
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            // تحديث معلومات البث
            document.getElementById('streamInfo').innerHTML = `
                <span id="currentProtocol">${currentProtocol.toUpperCase()}</span> | 
                <span id="currentQuality">جودة تلقائية</span>
            `;
            
            // التحقق من نوع الملف
            if (streamUrl.includes('.m3u8') && Hls.isSupported()) {
                // استخدام HLS.js لملفات m3u8
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    xhrSetup: (xhr) => {
                        xhr.withCredentials = false;
                        xhr.timeout = 10000; // 10 ثوان مهلة
                    }
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    showBufferIndicator(false);
                    video.play();
                    
                    // عرض خيارات الجودة إذا كانت متاحة
                    if (hls.levels && hls.levels.length > 1) {
                        showQualitySelector(hls.levels);
                    }
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS error:', data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                handleStreamError('خطأ في الشبكة', streamUrl);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                handleStreamError('خطأ في الوسائط', streamUrl);
                                break;
                            default:
                                handleStreamError('خطأ غير معروف', streamUrl);
                                break;
                        }
                    }
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // دعم HLS الأصلي (Safari)
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', () => {
                    showBufferIndicator(false);
                    video.play();
                });
                
            } else {
                // التدفق المباشر
                video.src = streamUrl;
                video.load();
                showBufferIndicator(false);
                video.play();
            }
            
            // إعداد مستمعي الأحداث
            setupVideoEvents(video);
            
            // التمرير لأعلى
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function generateStreamURL(id, type, extension = 'm3u8') {
            const base = currentProtocol === 'https' ? API_CONFIG.base_https : API_CONFIG.base_http;
            
            switch(type) {
                case 'live':
                    return `${base}/live/${API_CONFIG.user}/${API_CONFIG.pass}/${id}.${extension}`;
                case 'movie':
                    return `${base}/movie/${API_CONFIG.user}/${API_CONFIG.pass}/${id}.${extension}`;
                case 'series':
                    return `${base}/series/${API_CONFIG.user}/${API_CONFIG.pass}/${id}.${extension}`;
                default:
                    return `${base}/live/${API_CONFIG.user}/${API_CONFIG.pass}/${id}.${extension}`;
            }
        }

        function handleStreamError(errorMessage, streamUrl) {
            console.error(errorMessage, streamUrl);
            showBufferIndicator(false);
            
            // عرض رسالة خطأ
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${errorMessage}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="ml-4 text-sm underline">إغلاق</button>
            `;
            document.body.appendChild(errorDiv);
            
            // إزالة رسالة الخطأ تلقائياً بعد 5 ثوان
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function setupVideoEvents(video) {
            video.addEventListener('waiting', () => showBufferIndicator(true));
            video.addEventListener('playing', () => showBufferIndicator(false));
            video.addEventListener('error', (e) => {
                console.error('خطأ في الفيديو:', e);
                handleStreamError('خطأ في تشغيل الفيديو', video.src);
            });
        }

        function showBufferIndicator(show) {
            const indicator = document.getElementById('bufferIndicator');
            indicator.style.display = show ? 'block' : 'none';
        }

        function showQualitySelector(levels) {
            const selector = document.getElementById('qualitySelector');
            selector.innerHTML = '<div class="text-white text-sm mb-2">اختر الجودة:</div>';
            
            levels.forEach((level, index) => {
                const btn = document.createElement('button');
                btn.className = 'block w-full text-left px-2 py-1 text-white hover:bg-gray-700 rounded';
                btn.textContent = `${level.height}p`;
                btn.onclick = () => {
                    hls.currentLevel = index;
                    selector.style.display = 'none';
                };
                selector.appendChild(btn);
            });
            
            selector.style.display = 'block';
        }

        // ==================== دوال التبديل ====================

        function switchMode(mode) {
            currentMode = mode;
            
            // تحديث الأزرار النشطة
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // إعادة تعيين البحث
            document.getElementById('searchInput').value = '';
            
            // جلب الفئات الجديدة
            fetchCategories();
        }

        // ==================== البحث ====================

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            const grid = document.getElementById('contentGrid');
            
            if (!term) {
                // إذا كان البحث فارغاً، عرض جميع العناصر
                grid.innerHTML = '';
                displayedCount = 0;
                renderItems();
                return;
            }
            
            // البحث في البيانات
            const filtered = allData.filter(item => {
                const title = (item.name || item.title || '').toLowerCase();
                return title.includes(term);
            }).slice(0, 60); // تحديد النتائج
            
            // عرض النتائج
            grid.innerHTML = '';
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'media-card';
                
                const imageUrl = item.stream_icon || item.cover || 'https://via.placeholder.com/150';
                const title = item.name || item.title || 'بدون عنوان';
                const mediaId = item.stream_id || item.vod_id || item.id;
                
                // تمييز النص الذي تم البحث عنه
                const highlightedTitle = highlightText(title, term);
                
                div.innerHTML = `
                    <div class="relative">
                        <img src="${imageUrl}" 
                             class="w-full aspect-square object-cover bg-black rounded-lg"
                             onerror="this.src='https://via.placeholder.com/150'">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2">
                            <div class="text-xs font-bold text-white text-center">${highlightedTitle}</div>
                        </div>
                    </div>`;
                
                div.onclick = () => playMedia(mediaId, item);
                grid.appendChild(div);
            });
            
            document.getElementById('loadMoreBtn').style.display = 'none';
        });

        function highlightText(text, term) {
            if (!term) return text;
            
            const regex = new RegExp(`(${term})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // ==================== اختيار البروتوكول ====================

        document.getElementById('protocolSelect').addEventListener('change', (e) => {
            currentProtocol = e.target.value;
            
            if (currentProtocol === 'auto') {
                // استراتيجية التلقائي: حاول HTTPS أولاً، ثم HTTP
                currentProtocol = 'https';
            }
            
            // تحديث العرض
            const currentVideo = document.getElementById('player');
            if (currentVideo.src) {
                // إذا كان هناك فيديو يعرض، أعد تحميله بالبروتوكول الجديد
                const currentTime = currentVideo.currentTime;
                const isPlaying = !currentVideo.paused;
                
                // احصل على الـ ID الحالي من الرابط
                const urlParts = currentVideo.src.split('/');
                const currentId = urlParts[urlParts.length - 1].split('.')[0];
                
                // أوقف التشغيل الحالي
                if (hls) hls.destroy();
                currentVideo.pause();
                
                // ابحث عن العنصر الحالي في البيانات
                const currentItem = allData.find(item => 
                    (item.stream_id || item.vod_id || item.id) == currentId
                );
                
                if (currentItem) {
                    // أعد التشغيل بالبروتوكول الجديد
                    setTimeout(() => {
                        playMedia(currentId, currentItem);
                        if (isPlaying) {
                            currentVideo.currentTime = currentTime;
                        }
                    }, 500);
                }
            }
        });

        // ==================== التهيئة ====================

        document.addEventListener('DOMContentLoaded', () => {
            // تهيئة مشغل الفيديو
            player = new Plyr('#player', {
                controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
                settings: ['quality', 'speed'],
                keyboard: { focused: true, global: true }
            });
            
            // تعيين السنة الحالية
            document.getElementById('year').textContent = new Date().getFullYear();
            
            // استعادة الإعدادات
            const savedLang = localStorage.getItem('lang') || 'ar';
            const savedTheme = localStorage.getItem('theme') || 'dark';
            
            // تطبيق اللغة
            document.getElementById('langSelect').value = savedLang;
            setLanguage(savedLang);
            
            // تطبيق السمة
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
            
            // تحميل الفئات الأولية
            fetchCategories();
            
            // إعداد حدث التمرير
            window.onscroll = () => {
                const backToTop = document.getElementById('backToTop');
                backToTop.style.display = window.scrollY > 400 ? 'flex' : 'none';
                
                // التحميل التلقائي عند الوصول للأسفل
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                    if (document.getElementById('loadMoreBtn').style.display === 'block') {
                        renderItems();
                    }
                }
            };
        });

        // ==================== دوال إضافية ====================

        function refreshStream() {
            const video = document.getElementById('player');
            if (video.src) {
                const currentTime = video.currentTime;
                video.src += '?t=' + new Date().getTime(); // تجنب الكاش
                video.load();
                video.currentTime = currentTime;
                video.play();
            }
        }

        function downloadM3U() {
            const m3uContent = generateM3UPlaylist();
            const blob = new Blob([m3uContent], { type: 'audio/x-mpegurl' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dami-xpro-playlist.m3u';
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateM3UPlaylist() {
            let m3u = '#EXTM3U\n';
            allData.forEach(item => {
                const streamUrl = generateStreamURL(item.stream_id || item.vod_id, currentMode);
                m3u += `#EXTINF:-1,${item.name || item.title}\n`;
                m3u += `${streamUrl}\n`;
            });
            return m3u;
        }

        // إضافة أزرار التحكم إلى الشريط الجانبي
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarNav = document.querySelector('#sidebar nav');
            const controlButtons = `
                <div class="my-4 border-t border-[var(--border-color)]"></div>
                <div class="sidebar-link" onclick="refreshStream()">
                    <i class="fas fa-redo"></i> <span>تحديث البث</span>
                </div>
                <div class="sidebar-link" onclick="downloadM3U()">
                    <i class="fas fa-download"></i> <span>تحميل قائمة التشغيل</span>
                </div>
                <div class="sidebar-link" onclick="showServerInfo()">
                    <i class="fas fa-server"></i> <span>معلومات الخادم</span>
                </div>
            `;
            
            // إدراج الأزرار قبل رابط التحميل
            const downloadLink = sidebarNav.querySelector('a[href*="download"]');
            if (downloadLink) {
                downloadLink.insertAdjacentHTML('beforebegin', controlButtons);
            }
        });

        function showServerInfo() {
            const info = `
                <strong>معلومات الخادم:</strong><br>
                - HTTP: ${API_CONFIG.base_http}<br>
                - HTTPS: ${API_CONFIG.base_https}<br>
                - المستخدم: ${API_CONFIG.user}<br>
                - البروتوكول الحالي: ${currentProtocol}<br>
                - النمط الحالي: ${currentMode}
            `;
            
            alert(info);
        }

    </script>

</body>
</html>
